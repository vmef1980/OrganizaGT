<!DOCTYPE html>
<html lang="es-GT">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" id="meta-theme-color" content="#F47C20" />
  <title id="page-title">Cargando Catálogo...</title>

  <link rel="icon" id="favicon" href="" type="image/x-icon">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root {
      --primary: #F47C20;
      --primary-dark: #e06b10;
      --success: #28a745;
      --accent: #0074B7;
      --text-dark: #1C3F60;
      --text-soft: #666;
      --bg: #f8f9fa;
      --border: rgba(0,0,0,0.08);
      --shadow: 0 8px 32px rgba(0,0,0,0.08);
      --radius: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #fff8f0 0%, #e6f7ff 100%);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* --- SIDEBAR FILTROS --- */
    aside {
      width: 280px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      padding: 2rem 1.5rem;
      border-right: 1px solid var(--border);
      position: fixed;
      top: 0; left: 0; height: 100vh;
      overflow-y: auto;
      z-index: 1100;
      transition: var(--transition);
      box-shadow: 4px 0 15px rgba(0,0,0,0.02);
    }

    aside h2 { 
      font-size: 1.4rem; margin-bottom: 1.5rem; color: var(--text-dark); font-weight: 700;
      display: flex; align-items: center; gap: 10px;
    }

    .filtro { margin-bottom: 1.8rem; }
    .filtro label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
    
    input[type="text"], select {
      width: 100%; padding: 0.8rem 1rem; border: 1.5px solid var(--border); 
      border-radius: 12px; font-size: 0.95rem; font-family: inherit;
      transition: var(--transition); outline: none;
    }
    input[type="text"]:focus, select:focus { border-color: var(--primary); }

    .btn-reset {
      width: 100%; padding: 0.75rem; background: #f0f0f0; color: #666; 
      border: none; border-radius: 12px; font-weight: 600; cursor: pointer;
      transition: var(--transition); margin-top: 10px;
    }

    .checkbox-group { display: flex; flex-direction: column; gap: 0.8rem; padding: 0.5rem; }
    .checkbox-group label { font-weight: 400; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }

    /* BOTÓN FLOTANTE MÓVIL */
    .btn-toggle-filtros {
      position: fixed; top: 1rem; left: 1rem; z-index: 1000;
      background: var(--primary); color: white; border: none;
      width: 45px; height: 45px; border-radius: 12px;
      display: none; align-items: center; justify-content: center;
      box-shadow: var(--shadow); cursor: pointer;
    }

    /* --- CONTENIDO PRINCIPAL --- */
    main { margin-left: 280px; padding: 2rem; min-height: 100vh; transition: margin 0.3s; }
    
    header { text-align: center; margin-bottom: 3rem; margin-top: 1rem; }
    .logo-catalogo { width: 180px; margin-bottom: 1rem; border-radius: 15px; }
    h1 { 
      font-size: 2.2rem; font-weight: 800; 
      background: linear-gradient(135deg, var(--accent), var(--primary));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    /* GRID DE PRODUCTOS */
    #contenedor-catalogo { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
      gap: 2rem; max-width: 1200px; margin: 0 auto; 
    }
    
    .producto-catalogo { 
      background: white; border-radius: var(--radius); overflow: hidden; 
      box-shadow: var(--shadow); border: 1px solid var(--border); 
      transition: var(--transition); display: flex; flex-direction: column; 
    }
    .producto-catalogo:hover { transform: translateY(-5px); }

    /* CONTENEDOR DE IMAGEN (EXPORTABLE) */
    .seccion-superior { background: white; position: relative; }
    .imagen-contenedor {
      position: relative; height: 280px; background: white; 
      display: flex; align-items: center; justify-content: center; 
      padding: 20px; overflow: hidden; z-index: 1;
    }
    .imagen-contenedor img:not(.watermark-img) { 
      max-width: 100%; max-height: 100%; object-fit: contain; 
      z-index: 2; position: relative; 
    }

    /* MARCAS DE AGUA */
    .watermark {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
      font-weight: 900; font-size: 2.2rem; color: rgba(0,0,0,0.05);
      pointer-events: none; text-transform: uppercase; z-index: 3;
    }
    .watermark-img {
      position: absolute !important; bottom: 10px !important; right: 10px !important; 
      width: 65px !important; opacity: 0.6 !important; z-index: 10 !important;
    }

    .contenido-superior { padding: 1.5rem; text-align: center; border-top: 1px solid var(--border); }
    .contenido-superior h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text-dark); }
    .contenido-superior .descripcion { font-size: 0.85rem; color: var(--text-soft); margin-bottom: 1rem; line-clamp: 2; display: -webkit-box; -webkit-box-orient: vertical; overflow: hidden; }
    .contenido-superior .precio { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
    .producto-id { font-size: 0.75rem; color: #aaa; font-weight: 600; margin-top: 5px; }

    /* BOTONES */
    .seccion-inferior { 
      padding: 1.2rem; background: #fafafa; border-top: 1px dashed #ddd; 
      display: flex; flex-direction: column; gap: 0.8rem; 
    }
    .btn { 
      display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
      padding: 0.8rem; border-radius: 12px; font-size: 0.9rem; font-weight: 700; 
      text-decoration: none; transition: var(--transition); border: none; cursor: pointer;
    }
    .whatsapp-badge { background: var(--success); color: white; }
    .export-btn { background: var(--accent); color: white; }
    .btn:hover { opacity: 0.9; }

    .hashtags { font-size: 0.7rem; color: var(--accent); font-weight: 600; text-align: center; margin-top: 5px; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      aside { left: -280px; }
      aside.open { left: 0; }
      main { margin-left: 0; padding: 1rem; }
      .btn-toggle-filtros { display: flex; }
      #contenedor-catalogo { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
      .imagen-contenedor { height: 160px; }
      .contenido-superior h3 { font-size: 0.85rem; }
      .contenido-superior .descripcion { display: none; }
      .contenido-superior .precio { font-size: 1.2rem; }
      h1 { font-size: 1.6rem; }
    }
  </style>
</head>
<body>

  <button class="btn-toggle-filtros" id="btn-toggle-filtros">
    <i class="bi bi-funnel-fill"></i>
  </button>

  <aside id="filtros">
    <button id="close-aside" style="float:right; border:none; background:none; font-size:1.5rem; cursor:pointer;" class="bi bi-x-lg"></button>
    <h2><i class="bi bi-sliders"></i> Filtros</h2>
    
    <div class="filtro">
      <label>Buscar producto</label>
      <input type="text" id="busqueda" placeholder="Nombre o SKU..." />
    </div>

    <div class="filtro">
      <label>Categoría</label>
      <div id="contenedor-subcategoria"></div>
      <button class="btn-reset" id="btn-borrar-filtros">Limpiar filtros</button>
    </div>

    <div class="filtro">
      <label>Ordenar precio</label>
      <div class="checkbox-group">
        <label><input type="radio" name="orden" value="mayor"> De Mayor a Menor</label>
        <label><input type="radio" name="orden" value="menor"> De Menor a Mayor</label>
        <label><input type="radio" name="orden" value="default" checked> Orden inicial</label>
      </div>
    </div>
  </aside>

  <main id="main-content">
    <header>
      <img id="logo-header" src="" alt="Logo" class="logo-catalogo" />
      <h1 id="main-title">Cargando...</h1>
    </header>

    <section id="contenedor-catalogo"></section>

    <p class="nota" style="text-align:center; padding: 2rem; font-size: 0.8rem; color: var(--text-soft);">
      <i class="bi bi-info-circle"></i> Para guardar imágenes, usa <b>Chrome</b> o <b>Edge</b> y otorga permisos de carpeta.
    </p>
  </main>

  <script type="module">
    // ==========================================
    // 1. VARIABLES COMERCIALES (CONFIGURACIÓN)
    // ==========================================
    const CONFIG = {
      nombreNegocio: "OrganizaGT",
      telefonoWhatsApp: "50241084481",
      simboloMoneda: "Q",
      logoImg: "img/OrganizaGT-v2.png",
      watermarkImg: "img/OrganizaGT-MarcaAgua-v2.png",
      faviconImg: "img/OrganizaGT-v2.ico", 
      colores: {
        primario: "#F47C20",
        acento: "#0074B7"
      }
    };

    // ==========================================
    // 2. APLICAR CONFIGURACIÓN AL DOM
    // ==========================================
    const aplicarConfig = () => {
      document.title = `${CONFIG.nombreNegocio} - Catálogo`;
      document.getElementById("main-title").textContent = `Catálogo Digital - ${CONFIG.nombreNegocio}`;
      document.getElementById("logo-header").src = CONFIG.logoImg;
      document.getElementById("meta-theme-color").content = CONFIG.colores.primario;
      
      const fav = document.getElementById("favicon");
      if (fav) fav.href = CONFIG.faviconImg;
      
      const root = document.documentElement;
      root.style.setProperty('--primary', CONFIG.colores.primario);
      root.style.setProperty('--accent', CONFIG.colores.acento);
    };

    aplicarConfig();

    // ==========================================
    // 3. LÓGICA DE PRODUCTOS Y FILTROS
    // ==========================================
    import { productos } from "./js/productos.js";

    const contenedor = document.getElementById("contenedor-catalogo");
    const busquedaInput = document.getElementById("busqueda");
    const contenedorSubcat = document.getElementById("contenedor-subcategoria");
    const btnBorrarFiltros = document.getElementById("btn-borrar-filtros");
    const ordenRadios = document.querySelectorAll('input[name="orden"]');
    const aside = document.getElementById("filtros");
    const btnToggleFiltros = document.getElementById("btn-toggle-filtros");
    const btnCloseAside = document.getElementById("close-aside");
    
    let carpetaSeleccionada = null;

    // Control Sidebar
    btnToggleFiltros.onclick = () => aside.classList.add("open");
    btnCloseAside.onclick = () => aside.classList.remove("open");

    function obtenerNombreSubcategoria(subcat) {
      if (!subcat) return "";
      return (typeof subcat === "object" ? (subcat.nombre || subcat.name) : subcat).trim();
    }

    function generarHashtags(texto) {
      if (!texto) return "";
      const palabras = texto.toLowerCase().replace(/[^a-záéíóúüñ\s]/g, ' ').split(' ').filter(p => p.length > 3);
      return [...new Set(palabras)].slice(0,5).map(p => '#' + p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
    }

    async function cargarImagenExport(url) {
      try {
        const resp = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
        const blob = await resp.blob();
        return URL.createObjectURL(blob);
      } catch (e) { return url; }
    }

    async function renderizar(productosArray) {
      contenedor.innerHTML = "";
      if (productosArray.length === 0) {
        contenedor.innerHTML = `<p style="grid-column:1/-1; text-align:center; padding:3rem; color:#999;">No hay resultados.</p>`;
        return;
      }

      for (const p of productosArray) {
        const div = document.createElement("div");
        div.className = "producto-catalogo";
        const hashtags = generarHashtags(p.titulo);
        const mensajeWA = encodeURIComponent(`¡Hola ${CONFIG.nombreNegocio}! Me interesa:\n\n*${p.titulo}*\nPrecio: ${CONFIG.simboloMoneda}${p.precio.toFixed(2)}\nSKU: ${p.id}`);

        div.innerHTML = `
          <div class="seccion-superior" id="exportable-${p.id}">
            <div class="imagen-contenedor">
              <img src="${p.imagen}" alt="${p.titulo}" loading="lazy" />
              <div class="watermark">${CONFIG.nombreNegocio}</div>
              <img src="${CONFIG.watermarkImg}" class="watermark-img" onerror="this.style.display='none'">
            </div>
            <div class="contenido-superior">
              <h3>${p.titulo}</h3>
              <p class="descripcion">${p.descripcion || ""}</p>
              <p class="precio">${CONFIG.simboloMoneda}${p.precio.toFixed(2)}</p>
              <hr style="border: none; border-top: 1px solid var(--border); margin: 12px auto; width: 85%;">
              <p class="producto-id">SKU: ${p.id}</p>
            </div>
          </div>
          <div class="seccion-inferior">
            <a href="https://wa.me/${CONFIG.telefonoWhatsApp}?text=${mensajeWA}" class="btn whatsapp-badge" target="_blank">
              <i class="bi bi-whatsapp"></i> Consultar
            </a>
            <button class="btn export-btn" onclick="exportarConCarpeta('${p.id}')">
              <i class="bi bi-download"></i> Guardar Imagen
            </button>
            ${hashtags ? `<div class="hashtags">${hashtags}</div>` : ''}
          </div>
        `;
        contenedor.appendChild(div);
      }
    }

    function aplicarFiltros() {
      let filtrados = [...productos];
      const txt = busquedaInput.value.toLowerCase().trim();
      if (txt) filtrados = filtrados.filter(p => p.titulo.toLowerCase().includes(txt) || p.id.toLowerCase().includes(txt));

      const sel = document.getElementById("subcategoria-select");
      if (sel && sel.value) filtrados = filtrados.filter(p => obtenerNombreSubcategoria(p.subcategoria) === sel.value);

      const orden = document.querySelector('input[name="orden"]:checked').value;
      if (orden === "mayor") filtrados.sort((a,b) => b.precio - a.precio);
      else if (orden === "menor") filtrados.sort((a,b) => a.precio - b.precio);

      renderizar(filtrados);
    }

    window.exportarConCarpeta = async function(id) {
      const elemento = document.getElementById('exportable-'+id);
      const boton = elemento.parentElement.querySelector('.export-btn');
      const imgPrincipal = elemento.querySelector('.imagen-contenedor img:not(.watermark-img)');
      const originalSrc = imgPrincipal.src;
      
      boton.disabled = true;
      boton.innerHTML = '<i class="bi bi-hourglass-split"></i>...';
      
      try {
        const blobUrl = await cargarImagenExport(originalSrc);
        imgPrincipal.src = blobUrl;

        if (!carpetaSeleccionada) {
            carpetaSeleccionada = await window.showDirectoryPicker({mode:'readwrite'});
        }
        
        const canvas = await html2canvas(elemento, { 
            scale: 2, 
            useCORS: true, 
            backgroundColor: "#ffffff",
            logging: false 
        });

        const blob = await new Promise(r => canvas.toBlob(r,'image/png'));
        const handle = await carpetaSeleccionada.getFileHandle(`${CONFIG.nombreNegocio}_${id}.png`, {create:true});
        const writable = await handle.createWritable();
        await writable.write(blob);
        await writable.close();
        
        boton.innerHTML = '<i class="bi bi-check-circle"></i> ¡Listo!';
        setTimeout(() => {
            boton.innerHTML = '<i class="bi bi-download"></i> Guardar Imagen';
            boton.disabled = false;
        }, 2000);

      } catch(e) { 
        console.error(e);
        boton.disabled = false;
        boton.innerHTML = '<i class="bi bi-download"></i> Guardar Imagen';
      } finally {
        imgPrincipal.src = originalSrc;
      }
    };

    const init = () => {
      const cats = [...new Set(productos.map(p => obtenerNombreSubcategoria(p.subcategoria)).filter(s => s))].sort();
      contenedorSubcat.innerHTML = `
        <select id="subcategoria-select">
          <option value="">Todas las categorías</option>
          ${cats.map(c => `<option value="${c}">${c}</option>`).join('')}
        </select>
      `;

      document.getElementById("subcategoria-select").onchange = aplicarFiltros;
      busquedaInput.oninput = aplicarFiltros;
      ordenRadios.forEach(r => r.onchange = aplicarFiltros);
      btnBorrarFiltros.onclick = () => { 
        busquedaInput.value = ""; 
        document.getElementById("subcategoria-select").value = ""; 
        document.querySelector('input[value="default"]').checked = true;
        aplicarFiltros(); 
      };

      renderizar(productos);
    };

    init();
  </script>
</body>
</html>