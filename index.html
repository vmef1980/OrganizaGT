<!DOCTYPE html>
<html lang="es-GT" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="referrer" content="no-referrer-when-downgrade" />
  <meta name="robots" content="index, follow, noimageindex" />
  <meta name="theme-color" id="meta-theme-color" content="#F47C20" />
  
  <title id="page-title">Cargando Catálogo Profesional...</title>
  <meta name="description" id="meta-desc" content="Catálogo oficial de rompecabezas de alta calidad en Guatemala." />
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
  <link rel="icon" id="favicon" href="" type="image/x-icon">

  <style>
    /* [SEGURIDAD VISUAL] */
    body {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    img {
      -webkit-user-drag: none;
      pointer-events: none;
    }
    
    /* Re-habilitar eventos en elementos interactivos */
    input, button, .boton-categoria, .link-leer-mas, #whatsapp-link, #carrito-float, #boton-volver, .visor-principal, .thumb, .foto-principal, .nav-modal button, .btn-subfiltro, a {
      pointer-events: auto !important;
    }

    :root {
      --primary: #F47C20;
      --primary-dark: #e06b10;
      --success: #28a745;
      --accent: #0074B7;
      --highlight: #FFD447;
      --text-dark: #1C3F60;
      --text-soft: #666;
      --border: rgba(0,0,0,0.08);
      --shadow: 0 8px 32px rgba(0,0,0,0.08);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #fff8f0 0%, #e6f7ff 100%); color: var(--text-dark); line-height: 1.6; min-height: 100vh; }

    /* --- COMPONENTES UI --- */
    #toggle-menu { 
      position: fixed; top: 1rem; left: 1rem; z-index: 990; 
      background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
      border: none; padding: 0 1.4rem; height: 48px; border-radius: 30px; 
      font-size: 0.9rem; font-weight: 700; color: white; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
      cursor: pointer; display: flex; align-items: center; gap: 10px; transition: var(--transition);
      letter-spacing: 0.5px;
    }
    #toggle-menu:hover { transform: translateY(-2px); filter: brightness(1.1); }

    aside { 
      position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; 
      background: rgba(255,255,255,0.98); backdrop-filter: blur(16px); 
      border-right: 1px solid var(--border); transition: left 0.4s ease; 
      z-index: 1001; display: flex; flex-direction: column; 
    }
    aside.abierto { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.1); }
    aside header { padding: 2rem 1.5rem 1rem; text-align: center; flex-shrink: 0; }
    aside .logo { width: 180px; border-radius: 12px; pointer-events: none; }
    #buscar-categoria { width: 90%; margin: 0 auto 1rem; padding: 0.9rem; border: 1.5px solid var(--border); border-radius: 12px; flex-shrink: 0; font-family: inherit; }
    #menu-categorias { flex-grow: 1; overflow-y: auto; padding: 0 1rem 1rem; }

    .aside-footer { padding: 1.2rem; background: #fdfdfd; border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-soft); text-align: center; }
    .aside-footer .social-icons { margin-bottom: 8px; font-size: 1.1rem; display: flex; justify-content: center; gap: 15px; color: var(--primary); }
    .aside-footer .social-icons a { color: inherit; text-decoration: none; }

    .boton-categoria { display: block; width: 100%; margin-bottom: 0.5rem; padding: 0.9rem 1.2rem; background: white; border: none; border-radius: var(--radius); font-weight: 600; text-align: left; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .boton-categoria:hover { background: var(--primary); color: white; transform: translateX(5px); }
    #cerrar-menu { position: absolute; top: 1rem; right: 1rem; background: #eee; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    main { flex: 1; padding: 2rem 1rem 120px; max-width: 1200px; margin: 0 auto; padding-top: 5rem; }
    #titulo-principal { text-align: center; font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem; background: linear-gradient(135deg, var(--accent), var(--primary)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .subtitle-seo { text-align: center; font-size: 1rem; color: #555; max-width: 800px; margin: 0 auto 1.5rem; }

    /* FILTROS DE SUBCATEGORÍA */
    #contenedor-filtros-sub { display: flex; gap: 8px; overflow-x: auto; padding: 0.5rem 0 2rem; justify-content: center; flex-wrap: wrap; scrollbar-width: none; }
    #contenedor-filtros-sub::-webkit-scrollbar { display: none; }
    .btn-subfiltro { padding: 0.6rem 1.2rem; background: white; border: 1px solid var(--border); border-radius: 25px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: var(--transition); white-space: nowrap; color: var(--text-dark); }
    .btn-subfiltro.activo { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(244, 124, 32, 0.2); }

    /* FOOTER FIJO */
    .footer-principal { 
      position: fixed; 
      bottom: 0; 
      left: 0;
      width: 100%;
      padding: 1rem; 
      background: rgba(255,255,255,0.85); 
      backdrop-filter: blur(10px); 
      border-top: 1px solid var(--border); 
      text-align: center; 
      z-index: 900;
    }
    .footer-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 5px; font-size: 0.75rem; font-weight: 600; color: var(--text-dark); }
    .footer-links a { text-decoration: none; color: inherit; }
    .footer-info { font-size: 0.7rem; color: var(--text-soft); display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; align-items: center; }

    .trust-badges { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; max-width: 900px; margin: 0 auto 2.5rem; }
    .badge-card { background: white; padding: 1.2rem; border-radius: var(--radius); display: flex; align-items: flex-start; gap: 15px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.03); min-height: 140px; }
    .badge-card i { font-size: 1.8rem; color: var(--primary); background: #fff8f0; min-width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
    .badge-text h4 { font-size: 0.9rem; font-weight: 700; margin-bottom: 6px; }

    #contenedor-productos { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
    .producto { background: white; border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; transition: var(--transition); overflow: hidden; position: relative; }
    .producto:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
    
    .imagen-contenedor { width: 100%; padding-bottom: 100%; position: relative; background: #fff; cursor: pointer; }
    .imagen-contenedor img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; padding: 15px; z-index: 1; }

    .contenido { padding: 1.2rem; flex-grow: 1; display: flex; flex-direction: column; }
    .producto h3 { font-size: 0.95rem; margin-bottom: 0.5rem; font-weight: 600; }
    .descripcion-texto { font-size: 0.8rem; color: #666; display: -webkit-box; -webkit-line-clamp: 1; line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
    .descripcion-texto.completa { display: block; -webkit-line-clamp: initial; line-clamp: initial; }
    .link-leer-mas { display: inline-block; font-size: 0.75rem; color: var(--accent); font-weight: 700; cursor: pointer; text-decoration: underline; margin-top: 4px; }
    .precio { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-top: auto; }
    .btn-add { width: 100%; padding: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: var(--transition); }
    .btn-add.success-state { background: var(--success) !important; }

    #modal-producto { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-contenido { background: white; border-radius: 20px; max-width: 800px; width: 100%; position: relative; max-height: 90vh; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; padding: 2rem; }
    .visor-principal { position: relative; width: 100%; height: 350px; border: 1px solid var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #fff; overflow: hidden; }
    .foto-principal { max-width: 95%; max-height: 95%; object-fit: contain; z-index: 1; position: relative; }

    #carrito-float { position: fixed; right: 1rem; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; z-index: 999; box-shadow: var(--shadow); bottom: 85px; background: var(--highlight); color: var(--text-dark); }
    #whatsapp-link { position: fixed; right: 1rem; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; text-decoration: none; z-index: 999; box-shadow: var(--shadow); bottom: 155px; background: #25D366; font-size: 1.7rem; }
    #boton-volver { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: white; padding: 0.5rem 1.2rem; border-radius: 30px; box-shadow: var(--shadow); text-decoration: none; color: inherit; font-weight: 700; z-index: 998; font-size: 0.8rem; border: 1px solid var(--border); }

    .cerrar-modal { position: absolute; top: 10px; right: 10px; background: #eee; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; color: #333; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }

    @media (max-width: 600px) {
      .modal-contenido { grid-template-columns: 1fr; padding: 1.2rem; }
      #contenedor-productos { grid-template-columns: 1fr 1fr; gap: 0.8rem; }
      .trust-badges { grid-template-columns: 1fr; }
      .visor-principal { height: 250px; }
      #contenedor-filtros-sub { justify-content: flex-start; padding-left: 10px; padding-right: 10px; }
    }
  </style>
</head>
<body oncontextmenu="return false;"> 
  <button id="toggle-menu">
    <i class="bi bi-list"></i> 
    <span id="label-btn-menu">CATÁLOGO</span>
  </button>

  <aside id="aside-menu">
    <header>
        <img id="logo-sidebar" src="" alt="Logo" class="logo">
    </header>
    <input type="text" id="buscar-categoria" placeholder="¿Qué buscas hoy?">
    <nav id="menu-categorias"></nav>
    <div class="aside-footer" id="aside-footer-container"></div>
    <button id="cerrar-menu"><i class="bi bi-x-lg"></i></button>
  </aside>

  <main>
    <h1 id="titulo-principal"></h1>
    <p class="subtitle-seo" id="texto-subtitulo"></p>
    
    <div id="contenedor-filtros-sub"></div>

    <div class="trust-badges" id="container-badges"></div>
    <section id="contenedor-productos"></section>
  </main>

  <footer class="footer-principal">
    <div class="footer-content">
      <div class="footer-links" id="footer-social-links"></div>
      <div class="footer-info">
        <span id="f-copy"></span> | <span id="f-loc"></span> | <span id="f-dev"></span>
      </div>
    </div>
  </footer>

  <a href="carrito.html" id="carrito-float">
    <i class="bi bi-cart-fill"></i>
    <span id="contador-carrito" style="position:absolute; top:-2px; right:-2px; background:var(--primary); color:white; width:22px; height:22px; border-radius:50%; font-size:0.7rem; display:flex; align-items:center; justify-content:center; border:2px solid white; font-weight:bold;">0</span>
  </a>
  
  <a id="whatsapp-link" href="" target="_blank">
    <i class="bi bi-whatsapp"></i>
  </a>
  
  <a href="../index.html" id="boton-volver"><i class="bi bi-house-door-fill"></i> Volver</a>

  <div id="modal-producto">
    <div class="modal-contenido">
      <button class="cerrar-modal" id="cerrar-modal-btn"><i class="bi bi-x-lg"></i></button>
      <div class="galeria-modal">
        <div class="visor-principal">
            <img id="img-modal-principal" src="" class="foto-principal">
            <div class="nav-modal" id="nav-modal-fotos" style="position: absolute; width: 100%; display: flex; justify-content: space-between; padding: 0 10px; z-index: 5;">
                <button id="prev-foto" style="background:rgba(255,255,255,0.8); border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><i class="bi bi-chevron-left"></i></button>
                <button id="next-foto" style="background:rgba(255,255,255,0.8); border:none; border-radius:50%; width:35px; height:35px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><i class="bi bi-chevron-right"></i></button>
            </div>
        </div>
        <div id="modal-thumbnails" class="thumbnails" style="display:flex; gap:8px; margin-top:12px; overflow-x:auto; padding-bottom:5px;"></div>
      </div>
      <div class="info-modal">
        <h2 id="modal-titulo" style="margin-bottom:1rem; font-size:1.4rem; color:var(--text-dark);"></h2>
        <p id="modal-descripcion" style="margin-bottom:1.5rem; color:#555; font-size: 0.9rem; line-height:1.5;"></p>
        <div id="modal-precio" style="font-size:1.8rem; font-weight:800; color:var(--primary); margin-bottom:1.5rem;"></div>
        <button id="btn-agregar-modal" class="btn-add">Agregar al pedido</button>
      </div>
    </div>
  </div>

  <script type="module">
    // ==========================================
    // CONFIGURACIÓN GLOBAL
    // ==========================================
    const CONFIG = {
      nombreNegocio: "OrganizaGT",
      tituloPagina: "OrganizaGT | Catálogo Oficial 2026", // <--- NUEVA VARIABLE
      eslogan: "De todo para ORGANIZAR tus espacios",
      metaDescripcion: "Tu aliado en suministros de cocina en Guatemala. Calidad profesional en utensilios, repostería, bar y equipos para restaurantes.",
      copyright: "© 2026 Rompecabezas de Guatemala",
      developer: "Puzzle Solutions",
      ubicacion: "Guatemala City, GT",
      telefonoWhatsApp: "50241084481",
      mensajeWhatsApp: "Hola, deseo solicitar más información sobre los productos del catálogo.", 
      simboloMoneda: "Q",
      logoImg: "img/OrganizaGT-v2.png",
      faviconImg: "img/OrganizaGT-v2.ico",
      colores: {
        primario: "#F47C20",
        primarioOscuro: "#e06b10",
        acento: "#0074B7",
        fondoGradiente: "linear-gradient(135deg, #fff8f0 0%, #e6f7ff 100%)"
      },
      redesSociales: [
        { icon: "bi-facebook", url: "#", label: "Facebook" },
        { icon: "bi-instagram", url: "#", label: "Instagram" },
        { icon: "bi-tiktok", url: "#", label: "TikTok" }
      ],
      badges: [
        {
          icon: "bi-truck",
          titulo: "Envíos disponibles a toda Guatemala",
          items: ["• Entrega en 24 horas en la capital", "• Rastreo en tiempo real para departamentos" ]
        },
        {
          icon: "bi-shield-lock",
          titulo: "Compra fácil y seguro",
          items: ["• Efectivo", "• Tranferencia bancaria" , "• Pago contra entrega (deptos. 5% de comisión)", "• Tarjetas Visa (Aplican restricciones)"]
        }
      ]
    };

    const aplicarConfig = () => {
      // Actualizar título de la página desde la variable CONFIG
      document.title = CONFIG.tituloPagina; 
      
      // El resto de la configuración se mantiene igual
      document.getElementById("page-title").textContent = CONFIG.tituloPagina;
      document.getElementById("meta-desc").content = CONFIG.metaDescripcion;
      document.getElementById("favicon").href = CONFIG.faviconImg;
      document.getElementById("meta-theme-color").content = CONFIG.colores.primario;
      document.getElementById("titulo-principal").textContent = CONFIG.nombreNegocio;
      document.getElementById("texto-subtitulo").textContent = CONFIG.eslogan;
      document.getElementById("logo-sidebar").src = CONFIG.logoImg;

      const whatsappURL = `https://wa.me/${CONFIG.telefonoWhatsApp}?text=${encodeURIComponent(CONFIG.mensajeWhatsApp)}`;

      document.getElementById("aside-footer-container").innerHTML = `
        <div class="social-icons">
          ${CONFIG.redesSociales.map(r => `<a href="${r.url}" target="_blank"><i class="${r.icon}"></i></a>`).join('')}
          <a href="${whatsappURL}" target="_blank"><i class="bi bi-whatsapp"></i></a>
        </div>
        <p><strong>${CONFIG.nombreNegocio}</strong></p>
        <p style="opacity:0.7">${CONFIG.copyright}</p>
      `;

      document.getElementById("footer-social-links").innerHTML = `
        ${CONFIG.redesSociales.map(r => `
          <a href="${r.url}" target="_blank" style="font-size:0.75rem;"><i class="${r.icon}"></i> ${r.label}</a>
        `).join('')}
        <a href="${whatsappURL}" target="_blank" style="font-size:0.75rem;"><i class="bi bi-whatsapp"></i> WhatsApp</a>
      `;
      
      document.getElementById("f-copy").textContent = CONFIG.copyright;
      document.getElementById("f-loc").textContent = CONFIG.ubicacion;
      document.getElementById("f-dev").innerHTML = `Desarrollado por <strong>${CONFIG.developer}</strong>`;

      const linkWA = document.getElementById("whatsapp-link");
      linkWA.href = whatsappURL;
      
      const root = document.documentElement;
      root.style.setProperty('--primary', CONFIG.colores.primario);
      root.style.setProperty('--primary-dark', CONFIG.colores.primarioOscuro);
      root.style.setProperty('--accent', CONFIG.colores.acento);
      document.body.style.background = CONFIG.colores.fondoGradiente;

      document.getElementById("container-badges").innerHTML = CONFIG.badges.map(b => `
        <div class="badge-card">
          <i class="bi ${b.icon}"></i>
          <div class="badge-text">
            <h4>${b.titulo}</h4>
            <div style="font-size:0.75rem; color:#666">${b.items.map(i => `<div>${i}</div>`).join('')}</div>
          </div>
        </div>
      `).join('');
    };

    aplicarConfig();

    // ==========================================
    // LÓGICA FUNCIONAL (SIN CAMBIOS)
    // ==========================================
    import { productos } from "./js/productos.js";

    let fotosActuales = [];
    let indexActual = 0;
    const contador = document.getElementById("contador-carrito");
    const modal = document.getElementById("modal-producto");
    const aside = document.getElementById("aside-menu");
    const subContainer = document.getElementById("contenedor-filtros-sub");

    window.toggleDescripcion = (id) => {
      const txt = document.getElementById(`desc-${id}`);
      const link = document.getElementById(`link-${id}`);
      txt.classList.toggle('completa');
      link.textContent = txt.classList.contains('completa') ? "Ver menos" : "Ver más...";
    };

    window.cambiarFoto = (idx) => {
      indexActual = idx;
      const mainImg = document.getElementById("img-modal-principal");
      mainImg.src = fotosActuales[indexActual];
      
      document.querySelectorAll(".thumb").forEach((t, i) => {
        t.style.borderColor = i === idx ? 'var(--primary)' : '#eee';
        t.style.opacity = i === idx ? '1' : '0.6';
        t.style.transform = i === idx ? 'scale(1.05)' : 'scale(1)';
      });
    };

    window.openModalDirectly = (id) => {
      const p = productos.find(x => x.id === id);
      if(!p) return;
      
      let urls = [];
      if(p.imagen) urls.push(p.imagen);
      if(p.imagenes && Array.isArray(p.imagenes)) urls = urls.concat(p.imagenes);
      
      fotosActuales = [...new Set(urls)]; 
      indexActual = 0;
      
      document.getElementById("modal-titulo").textContent = p.titulo;
      document.getElementById("modal-descripcion").textContent = p.descripcion || "Sin descripción disponible.";
      document.getElementById("modal-precio").textContent = `${CONFIG.simboloMoneda}${p.precio.toFixed(2)}`;
      
      const thumbContainer = document.getElementById("modal-thumbnails");
      thumbContainer.innerHTML = "";
      
      fotosActuales.forEach((imgSrc, i) => {
        const imgThumb = document.createElement("img");
        imgThumb.src = imgSrc;
        imgThumb.className = "thumb";
        imgThumb.style = "width:60px; height:60px; object-fit:contain; border:2px solid #eee; cursor:pointer; border-radius:8px; transition: all 0.2s; background:#fff; flex-shrink:0;";
        imgThumb.onclick = (e) => { e.stopPropagation(); window.cambiarFoto(i); };
        thumbContainer.appendChild(imgThumb);
      });
      
      document.getElementById("nav-modal-fotos").style.display = fotosActuales.length > 1 ? "flex" : "none";
      
      window.cambiarFoto(0);
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";

      const btnModal = document.getElementById("btn-agregar-modal");
      btnModal.onclick = () => {
        addToCart(p);
        btnModal.classList.add("success-state");
        btnModal.textContent = "¡Añadido!";
        setTimeout(() => { cerrarModal(); btnModal.classList.remove("success-state"); btnModal.textContent = "Agregar al pedido"; }, 700);
      };
    };

    function addToCart(p) {
        const cart = JSON.parse(localStorage.getItem("carrito") || "[]");
        cart.push(p);
        localStorage.setItem("carrito", JSON.stringify(cart));
        updateCart();
    }

    function updateCart() {
      const cart = JSON.parse(localStorage.getItem("carrito") || "[]");
      contador.textContent = cart.length;
    }

    function renderProductos(lista) {
      const contenedor = document.getElementById("contenedor-productos");
      contenedor.innerHTML = "";
      lista.forEach(p => {
        const div = document.createElement("div");
        div.className = "producto";
        div.innerHTML = `
          <div class="imagen-contenedor" onclick="window.openModalDirectly('${p.id}')">
            <img src="${p.imagen}" alt="${p.titulo}" loading="lazy">
          </div>
          <div class="contenido">
            <h3>${p.titulo}</h3>
            <div class="descripcion-container">
                <p class="descripcion-texto" id="desc-${p.id}">${p.descripcion || ""}</p>
                ${p.descripcion && p.descripcion.length > 30 ? `<span class="link-leer-mas" id="link-${p.id}" onclick="window.toggleDescripcion('${p.id}')">Leer más...</span>` : ''}
            </div>
            <p class="precio">${CONFIG.simboloMoneda}${p.precio.toFixed(2)}</p>
            <button class="btn-add" data-id="${p.id}">Agregar</button>
          </div>
        `;
        contenedor.appendChild(div);
      });

      document.querySelectorAll(".btn-add").forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const p = productos.find(x => x.id === btn.dataset.id);
          addToCart(p);
          btn.classList.add("success-state");
          btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ¡Listo!';
          setTimeout(() => { btn.classList.remove("success-state"); btn.textContent = "Agregar"; }, 1000);
        };
      });
    }

    function generarSubfiltros(idCategoria, productosDeCat) {
        subContainer.innerHTML = "";
        
        const subcats = [...new Set(productosDeCat.map(p => {
            if (!p.subcategoria) return null;
            return (typeof p.subcategoria === "object") ? (p.subcategoria.nombre || p.subcategoria.name) : p.subcategoria;
        }).filter(s => s))].sort();

        if (subcats.length > 0) {
            const btnAll = document.createElement("button");
            btnAll.className = "btn-subfiltro activo";
            btnAll.textContent = "Todas";
            btnAll.onclick = () => {
                document.querySelectorAll(".btn-subfiltro").forEach(b => b.classList.remove("activo"));
                btnAll.classList.add("activo");
                renderProductos(productosDeCat);
                document.getElementById("contenedor-productos").scrollIntoView({ behavior: 'smooth', block: 'start' });
            };
            subContainer.appendChild(btnAll);

            subcats.forEach(sc => {
                const btnSc = document.createElement("button");
                btnSc.className = "btn-subfiltro";
                btnSc.textContent = sc;
                btnSc.onclick = () => {
                    document.querySelectorAll(".btn-subfiltro").forEach(b => b.classList.remove("activo"));
                    btnSc.classList.add("activo");
                    const filtrados = productosDeCat.filter(p => {
                        const pSub = (typeof p.subcategoria === "object") ? (p.subcategoria.nombre || p.subcategoria.name) : p.subcategoria;
                        return pSub === sc;
                    });
                    renderProductos(filtrados);
                    
                    const target = document.getElementById("contenedor-productos");
                    const offset = 120; 
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = target.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offsetPosition = elementPosition - offset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                };
                subContainer.appendChild(btnSc);
            });
        }
    }

    function cerrarModal() { modal.style.display = "none"; document.body.style.overflow = "auto"; }
    modal.onclick = (e) => { if(e.target === modal) cerrarModal(); };
    document.getElementById("cerrar-modal-btn").onclick = cerrarModal;
    
    document.getElementById("prev-foto").onclick = (e) => { 
      e.stopPropagation();
      indexActual = (indexActual - 1 + fotosActuales.length) % fotosActuales.length; 
      window.cambiarFoto(indexActual); 
    };
    document.getElementById("next-foto").onclick = (e) => { 
      e.stopPropagation();
      indexActual = (indexActual + 1) % fotosActuales.length; 
      window.cambiarFoto(indexActual); 
    };

    document.getElementById("toggle-menu").onclick = () => aside.classList.add("abierto");
    document.getElementById("cerrar-menu").onclick = () => aside.classList.remove("abierto");

    const menuCat = document.getElementById("menu-categorias");
    const cats = [...new Set(productos.map(p => p.categoria.id))].sort((a, b) => a.localeCompare(b));
    
    cats.forEach(c => {
      const btn = document.createElement("button");
      btn.className = "boton-categoria";
      btn.textContent = c.replace(/_/g, " ").toUpperCase();
      btn.onclick = () => { 
        const filtradosPorCat = productos.filter(p => p.categoria.id === c);
        renderProductos(filtradosPorCat); 
        generarSubfiltros(c, filtradosPorCat);
        aside.classList.remove("abierto"); 
        window.scrollTo({top: 0, behavior: 'smooth'}); 
      };
      menuCat.appendChild(btn);
    });

    document.getElementById("buscar-categoria").oninput = (e) => {
      const val = e.target.value.toLowerCase();
      subContainer.innerHTML = ""; 
      renderProductos(productos.filter(p => p.titulo.toLowerCase().includes(val) || p.categoria.id.toLowerCase().includes(val)));
    };

    renderProductos(productos);
    updateCart();

    document.getElementById("carrito-float").addEventListener("click", () => {
      sessionStorage.setItem("mainPageScroll", window.scrollY);
    });

    window.addEventListener("load", () => {
      const savedPos = sessionStorage.getItem("mainPageScroll");
      if (savedPos) {
        setTimeout(() => {
          window.scrollTo({
            top: parseInt(savedPos),
            behavior: "instant"
          });
          sessionStorage.removeItem("mainPageScroll");
        }, 150);
      }
    });

  </script>
</body>
</html>